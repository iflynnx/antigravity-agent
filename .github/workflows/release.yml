name: Release Build v2

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # Step 1: å…ˆåˆ›å»º Release
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          else
            VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
            TAG="v$VERSION"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: 'Antigravity Agent ${{ steps.version.outputs.tag }}'
          body: |
            ## ğŸ“¥ ä¸‹è½½å®‰è£…

            ### Windows
            - **å®‰è£…ç‰ˆ**ï¼ˆæ¨èï¼‰: [Antigravity.Agent_${{ steps.version.outputs.version }}_x64-setup.exe](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_x64-setup.exe) - æ”¯æŒè‡ªåŠ¨æ›´æ–°
            - **ä¾¿æºç‰ˆ**: [Antigravity-Agent-x86_64-Portable.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity-Agent-x86_64-Portable.zip) - è§£å‹å³ç”¨ï¼Œæ— éœ€å®‰è£…
            
            ### macOS
            - **Apple Silicon (M1/M2)**: [Antigravity.Agent_${{ steps.version.outputs.version }}_aarch64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_aarch64.dmg)
            - **Intel Mac**: [Antigravity.Agent_${{ steps.version.outputs.version }}_x86_64.dmg](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/Antigravity.Agent_${{ steps.version.outputs.version }}_x86_64.dmg)
            
            ### Linux
            - **AppImage**: [antigravity-agent_${{ steps.version.outputs.version }}_amd64.AppImage](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/antigravity-agent_${{ steps.version.outputs.version }}_amd64.AppImage) - é€šç”¨æ ¼å¼ï¼Œé€‚ç”¨äºæ‰€æœ‰å‘è¡Œç‰ˆ
            - **Debian/Ubuntu**: [antigravity-agent_${{ steps.version.outputs.version }}_amd64.deb](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/antigravity-agent_${{ steps.version.outputs.version }}_amd64.deb)
            ---

            ## ğŸ“‹ æ›´æ–°æ—¥å¿—

            ${{ github.event.release.body || format('è¯·æŸ¥çœ‹ [æäº¤å†å²](https://github.com/{0}/commits/{1}) è·å–è¯¦ç»†çš„æ›´æ–°å†…å®¹ã€‚', github.repository, steps.version.outputs.tag) }}

            ---

            ğŸ› å¦‚æœå‘ç°é—®é¢˜æˆ–è€…éœ€æ±‚è¯·æ±‚ï¼Œè¯·[æäº¤ Issue](https://github.com/MonchiLin/antigravity-agent/issues/new)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Step 2: å¹¶è¡Œæ„å»ºå’Œä¸Šä¼ 
  build:
    needs: prepare-release
    uses: ./.github/workflows/tauri-build.yml
    with:
      tag: ${{ needs.prepare-release.outputs.tag }}
      ref: ${{ github.ref }}
      version: ${{ needs.prepare-release.outputs.version }}
      cache_key_suffix: release
    secrets: inherit

  # Step 3: è§¦å‘ updater
  trigger-updater:
    needs: [prepare-release, build]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Generate updater configuration
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: generate-updater
          client-payload: '{"tag": "${{ needs.prepare-release.outputs.tag }}"}'
